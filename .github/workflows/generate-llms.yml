name: Generate SDK LLMS

on:
  workflow_dispatch:
    inputs:
      languages:
        description: "Which descriptions to generate"
        type: choice
        options: [en, kr, both]
        default: both
      llm_mode:
        description: "Generation mode"
        type: choice
        options: [changed, all]
        default: changed
      base:
        description: "Base ref/tag/sha for compare (optional)"
        type: string
        required: false
      head:
        description: "Head ref/tag/sha for compare (optional)"
        type: string
        required: false
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    name: Generate LLMS
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Compute compare range and inputs
        id: range
        shell: bash
        run: |
          set -euo pipefail
          # Defaults from inputs
          LANGUAGES="${{ inputs.languages || 'both' }}"
          LLM_MODE="${{ inputs.llm_mode || 'changed' }}"
          echo "LANGUAGES=$LANGUAGES" >> "$GITHUB_ENV"
          echo "LLM_MODE=$LLM_MODE" >> "$GITHUB_ENV"

          # Optionally honor explicit base/head
          if [[ -n "${{ inputs.base }}" && -n "${{ inputs.head }}" ]]; then
            echo "COMPARE=${{ inputs.base }}...${{ inputs.head }}" >> "$GITHUB_ENV"
          fi

          # If release event, try to set COMPARE to previous tag...current tag
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "HEAD_REF=$TAG" >> "$GITHUB_ENV"
            git fetch --tags --force --depth=1 origin "+refs/tags/*:refs/tags/*" || true
            BASE_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
            if [[ -n "$BASE_TAG" ]]; then
              echo "COMPARE=${BASE_TAG}...${TAG}" >> "$GITHUB_ENV"
            fi
          fi

          # Echo for debugging
          echo "LANGUAGES=${LANGUAGES}"
          echo "LLM_MODE=${LLM_MODE}"
          echo "COMPARE=${COMPARE:-"(none)"}"

      - name: Create update branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          BRANCH="chore/llms-${{ github.run_id }}-${{ github.run_attempt }}"
          git checkout -B "$BRANCH" "origin/${DEFAULT_BRANCH}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Run generators
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }} # used by scripts for GitHub compare API if needed
        run: |
          set -euo pipefail
          if [[ -z "${OPENAI_API_KEY:-}" ]]; then
            echo "OPENAI_API_KEY is not set. Add it in repository Secrets." >&2
            exit 1
          fi
          cd sdks/notifly-ios-sdk
          # Always fetch default branch for raw links
          git fetch origin "${{ github.event.repository.default_branch }}" --depth=1 || true

          # Determine per-language compare ranges (mirror local tested flow)
          if [[ "${LLM_MODE}" == "all" ]]; then
            EN_CMD='./scripts/generate_en_llms.ssh --llm-all'
            KR_CMD='./scripts/generate_kr_llms.ssh --llm-all'
          else
            # HEAD ref: inputs.head or default to origin/<default_branch>
            if [[ -n "${{ inputs.head }}" ]]; then
              HEAD_REF="${{ inputs.head }}"
            else
              HEAD_REF="origin/${{ github.event.repository.default_branch }}"
            fi

            if [[ -n "${COMPARE:-}" ]]; then
              EN_COMPARE="${COMPARE}"
              KR_COMPARE="${COMPARE}"
            else
              # Read base SHAs from existing files' headers
              BASE_EN="$(sed -nE 's/^<!--[[:space:]]*commit:[[:space:]]*([0-9a-f]+).*/\1/p' sdk-llms.txt | head -1 || true)"
              BASE_KR="$(sed -nE 's/^<!--[[:space:]]*commit:[[:space:]]*([0-9a-f]+).*/\1/p' sdk-llms-kr.txt | head -1 || true)"
              # Fallback to HEAD_REF if missing (no changes)
              [[ -z "${BASE_EN}" ]] && BASE_EN="${HEAD_REF}"
              [[ -z "${BASE_KR}" ]] && BASE_KR="${HEAD_REF}"
              EN_COMPARE="${BASE_EN}...${HEAD_REF}"
              KR_COMPARE="${BASE_KR}...${HEAD_REF}"
            fi
            EN_CMD='./scripts/generate_en_llms.ssh --compare "'"${EN_COMPARE}"'" --llm'
            KR_CMD='./scripts/generate_kr_llms.ssh --compare "'"${KR_COMPARE}"'" --llm'
          fi

          case "${LANGUAGES}" in
            en) eval "${EN_CMD}" ;;
            kr) eval "${KR_CMD}" ;;
            both) eval "${EN_CMD}"; eval "${KR_CMD}" ;;
          esac

      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail
          cd sdks/notifly-ios-sdk
          # Stage files if present
          git add sdk-llms.txt sdk-llms-kr.txt 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update sdk-llms indexes [skip ci]"
          git push origin "HEAD:${BRANCH}"

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          script: |
            const defaultBranch = context.payload.repository.default_branch;
            const head = process.env.BRANCH;
            const title = 'chore: update sdk-llms indexes';
            const body = [
              'This PR updates the generated SDK LLMS indices.',
              '',
              `- Triggered by: ${context.eventName}`,
              `- Range: ${process.env.COMPARE || '(none / full)'}`
            ].join('\n');
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                head,
                base: defaultBranch,
                body
              });
              core.info(`Created PR #${pr.number}`);
            } catch (e) {
              if (e.status === 422) {
                core.info('PR likely already exists or no changes to propose.');
              } else {
                throw e;
              }
            }

